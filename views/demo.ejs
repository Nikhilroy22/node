<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Firebase Web Push Demo</title>
  <!-- Dev-specific scripts -->
  <script src="/js/eruda.js"></script>
  <script>
    eruda.init(); // Console চালু হবে
  </script>
</head>
<body>
  <h1>Firebase Web Push Notification Demo</h1>
  <button id="notifyBtn">Send Test Notification</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDa1jib5JJfboOMkhw64Nwl6ia_LfcOoRk",
      authDomain: "node-dc510.firebaseapp.com",
      projectId: "node-dc510",
      storageBucket: "node-dc510.firebasestorage.app",
      messagingSenderId: "917525434182",
      appId: "1:917525434182:web:265054ff20ea2a08409f47",
      measurementId: "G-B6RK58PGN2"
    };

    const app = initializeApp(firebaseConfig);
    const messaging = getMessaging(app);

    // Service Worker register এবং push token generate একসাথে
    async function initPush() {
      try {
        // 1️⃣ Register Service Worker
        const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
        console.log('Service Worker registered');

        // 2️⃣ Request Notification Permission
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
          console.warn('Notification permission not granted');
          return;
        }

        // 3️⃣ Get FCM token
        const token = await getToken(messaging, {
          vapidKey: "BDOJPavROsYTPloF7fcqsGVT9kFJuGjSngzbqkPPXrKKrl0LGdY08fZBcogSjSQ6hUdTflSALqW9l8l8cNmtf5Y",
          serviceWorkerRegistration: registration
        });
        console.log("Device Token:", token);

        // 4️⃣ Save token to backend
        await fetch("/save-token", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token })
        });

      } catch (err) {
        console.error("Push init failed:", err);
      }
    }

    initPush();

    // Foreground notification listener
    /*onMessage(messaging, payload => {
      alert("Notification: " + payload.notification.title + "\n" + payload.notification.body);
    });*/

    // Test button → trigger server notification
    document.getElementById("notifyBtn").addEventListener("click", async () => {
      await fetch("/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          title: "Test Notification",
          body: "This is a test notification from server"
        })
      });
    });
  </script>
</body>
</html>