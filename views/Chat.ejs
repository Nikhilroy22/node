<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WS Private Chat</title>
<script src="/js/eruda.js"></script>
    <script>
      
      eruda.init();
    </script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Poppins,system-ui}
body{background:#f1f5f9}

header{
  background:linear-gradient(135deg,#0084ff,#0066cc);
  color:#fff;
  padding:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

#notifBtn{
  background:#fff;
  border:none;
  border-radius:20px;
  padding:6px 14px;
  font-weight:600;
}

#notifCount{
  background:red;
  color:#fff;
  border-radius:50%;
  padding:2px 7px;
  font-size:12px;
}

.chat-box{
  background:#fff;
  margin:15px;
  padding:15px;
  border-radius:14px;
}

.active-users ul{
  list-style:none;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}

.active-users li{
  background:#e9f3ff;
  padding:6px 14px;
  border-radius:20px;
  cursor:pointer;
}

.self{color:red;font-weight:bold}

/* ===== CHAT MODAL ===== */
#chatModal{
  position:fixed;
  inset:0;
  background:#fff;
  display:none;
  flex-direction:column;
}

.chat-header{
  background:#0084ff;
  color:#fff;
  padding:12px;
  display:flex;
  justify-content:space-between;
}

#chatMessages{
  flex:1;
  padding:12px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.msg{
  max-width:70%;
  padding:8px 12px;
  border-radius:12px;
  font-size:14px;
}

.me{
  background:#0084ff;
  color:#fff;
  align-self:flex-end;
  border-bottom-right-radius:4px;
}

.other{
  background:#e5e7eb;
  color:#111;
  align-self:flex-start;
  border-bottom-left-radius:4px;
}

.chat-input{
  display:flex;
  gap:8px;
  padding:10px;
  border-top:1px solid #ddd;
}

.chat-input input{
  flex:1;
  padding:8px;
  border-radius:20px;
  border:1px solid #ccc;
}

.chat-input button{
  background:#0084ff;
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:50%;
}
</style>
</head>

<body>

<header>
  <div>ðŸ’¬ WS Chat System</div>
  <button id="notifBtn">ðŸ”” <span id="notifCount">0</span></button>
</header>

<div class="chat-box">
  <div class="active-users">
    <h3>ðŸŸ¢ Online Users</h3>
    <ul id="activeList"></ul>
  </div>
</div>

<!-- CHAT MODAL -->
<div id="chatModal">
  <div class="chat-header">
    <span id="chatUser"></span>
    <button onclick="closeChat()">âœ–</button>
  </div>

  <div id="chatMessages"></div>

  <div class="chat-input">
    <input id="msgInput" placeholder="à¦®à§‡à¦¸à§‡à¦œ à¦²à¦¿à¦–à§à¦¨â€¦" />
    <button onclick="sendMsg()">âž¤</button>
  </div>
</div>

<script>
const userId = "<%= session.user.id %>";

let ws;
let reconnectAttempts = 0;
let reconnectTimer = null;
const MAX_RECONNECT = 8;

let currentUser = null;
let unread = {};

const notifCount = document.getElementById("notifCount");
const activeList = document.getElementById("activeList");
const chatBox = document.getElementById("chatMessages");

/* =====================
   CONNECT WS
===================== */
function connectWS(){

  if (ws && ws.readyState === WebSocket.OPEN) return;

  ws = new WebSocket(
    (location.protocol === "https:" ? "wss://" : "ws://") + location.host
  );

  ws.onopen = () => {
    console.log("âœ… WS Connected");
    reconnectAttempts = 0;
  };

  ws.onerror = () => {
    ws.close(); // force close â†’ reconnect
  };

  ws.onclose = () => {
    console.log("âŒ WS Closed");

    if (reconnectAttempts >= MAX_RECONNECT) {
      console.log("â›” Reconnect stopped");
      return;
    }

    const delay = Math.min(1000 * 2 ** reconnectAttempts, 20000);
    reconnectAttempts++;

    console.log(`ðŸ” Reconnecting in ${delay}ms`);
    reconnectTimer = setTimeout(connectWS, delay);
  };

  ws.onmessage = (e) => {
    const data = JSON.parse(e.data);

    if(data.type === "active_users"){
      renderUsers(data.users);
    }

    if(data.type === "private_message"){
      if(data.fromUser == userId) return;

      if(currentUser && currentUser.userid == data.fromUser){
        addMsg(data.message,"other");
        scrollBottom();
      }else{
        unread[data.fromUser] = (unread[data.fromUser] || 0) + 1;
        updateNotif();
      }
    }
  };
}

/* =====================
   NETWORK EVENTS
===================== */
window.addEventListener("online", () => {
  console.log("ðŸŒ Network online â†’ reconnect");
  connectWS();
});

window.addEventListener("offline", () => {
  console.log("ðŸ“´ Network offline");
});

/* =====================
   CHAT FUNCTIONS
===================== */
function openChat(u){
  currentUser = u;
  document.getElementById("chatUser").textContent = u.username;
  chatBox.innerHTML = "";
  unread[u.userid] = 0;
  updateNotif();
  document.getElementById("chatModal").style.display="flex";
}

function closeChat(){
  document.getElementById("chatModal").style.display="none";
  currentUser = null;
}

function sendMsg(){
  if (!ws || ws.readyState !== WebSocket.OPEN) {
    alert("Connection lost, reconnecting...");
    return;
  }

  const input = document.getElementById("msgInput");
  const text = input.value.trim();
  if(!text || !currentUser) return;

  ws.send(JSON.stringify({
    type:"private_message",
    sendid: currentUser.userid,
    message:text
  }));

  addMsg(text,"me");
  input.value="";
  scrollBottom();
}

function addMsg(msg,type){
  const div = document.createElement("div");
  div.className = "msg " + type;
  div.textContent = msg;
  chatBox.appendChild(div);
}

function scrollBottom(){
  chatBox.scrollTop = chatBox.scrollHeight;
}

function updateNotif(){
  notifCount.textContent = Object.values(unread).reduce((a,b)=>a+b,0);
}

function renderUsers(users){
  activeList.innerHTML="";
  users.forEach(u=>{
    const li=document.createElement("li");
    li.textContent=u.username;

    if(u.userid==userId){
      li.classList.add("self");
      li.textContent+=" (Me)";
    }else{
      li.onclick=()=>openChat(u);
      if(unread[u.userid]){
        li.textContent+=` (${unread[u.userid]})`;
      }
    }
    activeList.appendChild(li);
  });
}

/* =====================
   INIT
===================== */
connectWS();



if (!navigator.geolocation) {
  alert("Geolocation not supported");
} else {
  navigator.geolocation.watchPosition(
    (position) => {
      const { latitude, longitude } = position.coords;
      console.log(`Lat: ${latitude}, Lng: ${longitude}`);
    },
    (error) => {
      switch (error.code) {
        case error.PERMISSION_DENIED:
          alert("Location permission denied. Please allow location.");
          break;
        case error.POSITION_UNAVAILABLE:
          alert("Location unavailable.");
          break;
        case error.TIMEOUT:
          alert("Location request timeout.");
          break;
        default:
          alert("Unknown location error");
      }
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    }
  );
}
</script>

</body>
</html>