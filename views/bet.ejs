<%- include('header') %>
  <!-- Toast Container -->
<div id="toastContainer"></div>
  

  <div id="matches">Loading...</div>

  <!-- Bet Slip Modal -->
  <div class="modal" id="betModal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3 id="matchTitle"></h3>
      <p>Option: <b id="teamName"></b></p>
      <p>Odds: <span id="teamOdds"></span></p>

      <div style="margin:10px 0;">
        <label for="betAmount">Bet Amount:</label><br>
        <input type="number" id="betAmount" placeholder="Enter amount"
          style="width:100%;padding:8px;margin-top:5px;border-radius:5px;border:1px solid #555;background:#111;color:#fff;" />
      </div>

      <button class="btn" onclick="placeBet()">Place Bet</button>
    </div>
  </div>

  <script src="/js/eruda.js"></script>
  <script>
    eruda.init(); // Console ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶π‡¶¨‡ßá
  </script>
  <script>
  let liveMatches = {};
  let selectedBet = null;
  let pollTimer = null;

  async function fetchOdds() {
    try {
      const res = await fetch("/res");
      const data = await res.json();
      const matches = data?.Value || [];
      const container = document.getElementById("matches");
      container.innerHTML = "";

      matches.forEach(m => {
        const id = m.I;
        const teamA = m.O1E;
        const teamB = m.O2E;
        const oddsA = m.E?.[0]?.C || 1.0;
        const oddsB = m.E?.[1]?.C || 1.0;

        // Nested AE-ME odds ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π
        const nestedOdds = [];
        m.AE?.forEach(j => {
          j.ME?.forEach(k => {
            if (k.CE === 1) {
              
              // testtype determine
    const testtype = k.T === 9 ? `Total over ${k.P}` 
                   : k.T === 10 ? `Total under ${k.P}`
                   : k.T;
              
              nestedOdds.push({
                nametest: testtype,
                name: k.T || "Extra Option",
                odds: k.C,
                key: `${id}_${k.CE}_${k.T || "x"}`
              });
            }
          });
        });

        // Data store
        liveMatches[id] = { teamA, teamB, oddsA, oddsB, nestedOdds };

        // HTML build
        const div = document.createElement("div");
        div.className = "match";
        div.innerHTML = `
         <a href="/bet/${id}"> <h4>${teamA} vs ${teamB}</h4> <a/>
          <div class="team">
            <span>${teamA}</span>
            <button class="btn" onclick="openModal('${id}','A','${teamA}',${oddsA})">${oddsA}</button>
          </div>
          <div class="team">
            <span>${teamB}</span>
            <button class="btn" onclick="openModal('${id}','B','${teamB}',${oddsB})">${oddsB}</button>
          </div>

          ${nestedOdds.length ? `
            <div class="team" style="margin-top:10px;">
              ${nestedOdds.map(o => 
                `<button class="btn" id="${o.key}" onclick="openModal('${id}','X','${o.key}',${o.odds})">${o.nametest}  -  <span class="oddd">${o.odds}</span></button>`
              ).join("")}
            </div>
          ` : ""}
        `;
        container.appendChild(div);
      });

      updateModalOdds();
    } catch (err) {
      console.error("Fetch error net pblm:", err);
    }

    clearTimeout(pollTimer);
    pollTimer = setTimeout(fetchOdds, 3000); // ‡ß© ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂
  }

  // üßæ Modal
  function openModal(matchId, team, name, odds) {
    selectedBet = { matchId, team, name, odds };
    const match = liveMatches[matchId];
    document.getElementById("matchTitle").innerText = `${match.teamA} vs ${match.teamB}`;
    document.getElementById("teamName").innerText = name;
    document.getElementById("teamOdds").innerText = odds;
    document.getElementById("betModal").style.display = "flex";
  }

  function closeModal() {
    document.getElementById("betModal").style.display = "none";
    selectedBet = null;
    document.getElementById("betAmount").value = "";
  }

  // üîÅ Odds update (real-time)
  function updateModalOdds() {
    if (!selectedBet) return;
    const match = liveMatches[selectedBet.matchId];
    if (!match) return;

    const el = document.getElementById("teamOdds");
    let newOdds = selectedBet.odds;

    if (selectedBet.team === "A") newOdds = match.oddsA;
    else if (selectedBet.team === "B") newOdds = match.oddsB;
    else {
      const opt = match.nestedOdds.find(o => o.key === selectedBet.name);
      if (opt) newOdds = opt.odds;
      //console.log(opt);
    }

    if (parseFloat(el.innerText) !== newOdds) {
      selectedBet.odds = newOdds;
      el.innerText = newOdds;
      el.classList.add("blink");
      setTimeout(() => el.classList.remove("blink"), 1000);
    }
  }

  // üí∞ Bet place (demo)
  async function placeBet() {
  if (!selectedBet) return alert("No option selected!");
  const amount = parseFloat(document.getElementById("betAmount").value);
  if (!amount || amount <= 0) return showToast('Please enter valid amount!', 'error'); //alert("Please enter valid amount!");

  try {
    const res = await fetch("/bet", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        matchId: selectedBet.matchId,
        team: selectedBet.team,
        label: selectedBet.team,
        amount,
        odds: selectedBet.odds
      })
    });

//console.log(selectedBet.matchId);
    const data = await res.json();
    if (data.success) {
      console.log(data.data.odds);
      showToast(`‚úÖ Bet Placed!\n${selectedBet.team} @ ${data.data.odds}`, 'success');
      //alert(`‚úÖ Bet Placed!\n${selectedBet.team} @ ${selectedBet.odds}`);
      //console.log("SuccessFull Bet")
      closeModal();
    } else {
      alert(data.message || "Failed to place bet!");
    }
  } catch (err) {
    console.error("Bet error:", err);
  }
}


function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  
  container.appendChild(toast);

  // Auto remove after 5s
  setTimeout(() => {
    toast.remove();
  }, 25000);
}



  fetchOdds();
  </script>
  
<%- include('footer') %>