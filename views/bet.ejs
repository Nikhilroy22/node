<%- include('header') %>

<!-- Toast -->
<div id="toastContainer"></div>

<!-- Matches -->
<div id="matches" class="loading">Loading matches...</div>

<!-- =====================
     BET MODAL
===================== -->
<div class="placebetmodal" id="betModal">
  <div class="placebetmodal-content">
    <span class="placebetclose" onclick="closeModal()">&times;</span>

    <h3 id="matchTitle"></h3>
    <p>Option: <b id="teamName"></b></p>
    <p>Odds: <span id="teamOdds"></span></p>

    <div style="margin:10px 0;">
      <label>Bet Amount</label>
      <input
        type="number"
        id="betAmount"
        value="500"
        min="1"
        style="width:100%;padding:8px;margin-top:5px;border-radius:5px;border:1px solid #555;background:#111;color:#fff;"
      />
    </div>

    <button class="btn" onclick="placeBet()">Place Bet</button>
  </div>
</div>

<script>
/* =====================
   STATE
===================== */
const state = {
  liveMatches: {},
  selectedBet: null,
  pollTimer: null,
  REFRESH_INTERVAL: 3000,
  domCache: new Map()   // ðŸ§  DOM cache
};

/* =====================
   FETCH ODDS
===================== */
async function fetchOdds() {
  try {
    const res = await fetch("/res");
    if (!res.ok) throw new Error("Network error");

    const data = await res.json();
    const matches = data?.Value || [];

    renderMatches(matches);
    updateModalOdds();

  } catch (err) {
    console.error("Fetch odds error:", err);
  } finally {
    clearTimeout(state.pollTimer);
    state.pollTimer = setTimeout(fetchOdds, state.REFRESH_INTERVAL);
  }
}

/* =====================
   RENDER MATCH LIST (NO SCROLL RESET)
===================== */
function renderMatches(matches) {
  const container = document.getElementById("matches");

  if (!matches.length) {
    container.replaceChildren(
      Object.assign(document.createElement("div"), {
        className: "empty",
        textContent: "No live matches"
      })
    );
    return;
  }

  matches.forEach(m => {
    const id = m.I;

    if (state.domCache.has(id)) {
      // ðŸ” update only odds
      updateMatchNode(m, state.domCache.get(id));
    } else {
      // âž• new match
      const node = createMatchNode(m);
      state.domCache.set(id, node);
      container.appendChild(node);
    }
  });
}

/* =====================
   CREATE MATCH NODE
===================== */
function createMatchNode(m) {
  const id = m.I;
  const teamA = m.O1E;
  const teamB = m.O2E;
  const oddsA = m.E?.[0]?.C || 1.0;
  const oddsB = m.E?.[1]?.C || 1.0;

  const nestedOdds = [];

  m.AE?.forEach(a =>
    a.ME?.forEach(k => {
      if (k.CE !== 1) return;

      const label =
        k.T === 9 ? `Total Over ${k.P}` :
        k.T === 10 ? `Total Under ${k.P}` :
        `Option ${k.T}`;

      nestedOdds.push({
        key: `${id}_${k.CE}_${k.T}`,
        label,
        odds: k.C
      });
    })
  );

  state.liveMatches[id] = { teamA, teamB, oddsA, oddsB, nestedOdds };

  const div = document.createElement("div");
  div.className = "match";
  div.dataset.id = id;

  const title = document.createElement("a");
  title.href = `/bet/${id}`;
  title.className = "match-title";
  title.textContent = `${teamA} vs ${teamB}`;

  div.appendChild(title);
  div.appendChild(createTeamRow(id, "A", teamA, oddsA));
  div.appendChild(createTeamRow(id, "B", teamB, oddsB));

  if (nestedOdds.length) {
    const extra = document.createElement("div");
    extra.className = "teamm";

    nestedOdds.forEach(o => {
      const btn = document.createElement("button");
      btn.className = "btnn";
      btn.innerHTML = `${o.label} - <span class="oddd" data-key="${o.key}">${o.odds}</span>`;
      btn.addEventListener("click", () =>
        openModal(id, "X", o.key, o.odds)
      );
      extra.appendChild(btn);
    });

    div.appendChild(extra);
  }

  return div;
}

/* =====================
   UPDATE MATCH NODE (ONLY ODDS)
===================== */
function updateMatchNode(m, node) {
  const oddsA = m.E?.[0]?.C || 1.0;
  const oddsB = m.E?.[1]?.C || 1.0;

  state.liveMatches[m.I].oddsA = oddsA;
  state.liveMatches[m.I].oddsB = oddsB;

  const btnA = node.querySelector('[data-team="A"]');
  const btnB = node.querySelector('[data-team="B"]');

  if (btnA && btnA.textContent != oddsA) {
    btnA.textContent = oddsA;
    blink(btnA);
  }

  if (btnB && btnB.textContent != oddsB) {
    btnB.textContent = oddsB;
    blink(btnB);
  }

  m.AE?.forEach(a =>
    a.ME?.forEach(k => {
      if (k.CE !== 1) return;

      const key = `${m.I}_${k.CE}_${k.T}`;
      const el = node.querySelector(`[data-key="${key}"]`);

      if (el && el.textContent != k.C) {
        el.textContent = k.C;
        blink(el);
      }
    })
  );
}

/* =====================
   TEAM ROW
===================== */
function createTeamRow(matchId, team, name, odds) {
  const row = document.createElement("div");
  row.className = "team";

  const span = document.createElement("span");
  span.textContent = name;

  const btn = document.createElement("button");
  btn.className = "btn";
  btn.dataset.team = team;
  btn.textContent = odds;
  btn.addEventListener("click", () =>
    openModal(matchId, team, name, odds)
  );

  row.append(span, btn);
  return row;
}

/* =====================
   BLINK HELPER
===================== */
function blink(el) {
  el.classList.add("blink");
  setTimeout(() => el.classList.remove("blink"), 800);
}

/* =====================
   MODAL
===================== */
function openModal(matchId, team, name, odds) {
  state.selectedBet = { matchId, team, name, odds };
  const match = state.liveMatches[matchId];

  document.getElementById("matchTitle").textContent =
    `${match.teamA} vs ${match.teamB}`;
  document.getElementById("teamName").textContent = name;
  document.getElementById("teamOdds").textContent = odds;
  document.getElementById("betModal").style.display = "flex";
}

function closeModal() {
  document.getElementById("betModal").style.display = "none";
  state.selectedBet = null;
  document.getElementById("betAmount").value = 500;
}

/* =====================
   LIVE MODAL ODDS
===================== */
function updateModalOdds() {
  const bet = state.selectedBet;
  if (!bet) return;

  const match = state.liveMatches[bet.matchId];
  if (!match) return;

  let newOdds = bet.odds;

  if (bet.team === "A") newOdds = match.oddsA;
  else if (bet.team === "B") newOdds = match.oddsB;
  else {
    const opt = match.nestedOdds.find(o => o.key === bet.name);
    if (opt) newOdds = opt.odds;
  }

  const el = document.getElementById("teamOdds");
  if (Number(el.textContent) !== newOdds) {
    el.textContent = newOdds;
    bet.odds = newOdds;
    blink(el);
  }
}

/* =====================
   INIT
===================== */
fetchOdds();


function placeBet(){
  
  
showToast("Invalid credentials", "error");

}
</script>

<%- include('footer') %>