<%- include('header') %>

<!-- Toast -->
<div id="toastContainer"></div>

<!-- Matches -->
<div id="matches" class="loading">Loading matches...</div>

<!-- =====================
     BET MODAL
===================== -->
<div class="placebetmodal" id="betModal">
  <div class="placebetmodal-content">
    <span class="placebetclose" onclick="closeModal()">&times;</span>

    <h3 id="matchTitle"></h3>
    <p>Option: <b id="teamName"></b></p>
    <p>Odds: <span id="teamOdds"></span></p>

    <div style="margin:10px 0;">
      <label>Bet Amount</label>
      <input
        type="number"
        id="betAmount"
        value="500"
        min="1"
        style="width:100%;padding:8px;margin-top:5px;border-radius:5px;border:1px solid #555;background:#111;color:#fff;"
      />
    </div>

    <button class="btn" onclick="placeBet()">Place Bet</button>
  </div>
</div>

<script>
/* =====================
   STATE
===================== */
let liveMatches = {};
let selectedBet = null;
let pollTimer = null;
const REFRESH_INTERVAL = 3000;

/* =====================
   FETCH ODDS
===================== */
async function fetchOdds() {
  try {
    const res = await fetch("/res");
    if (!res.ok) throw new Error("Network error");

    const data = await res.json();
    const matches = data?.Value || [];
    const container = document.getElementById("matches");
    container.innerHTML = "";

    if (!matches.length) {
      container.innerHTML = "<div class='empty'>No live matches</div>";
      return;
    }

    matches.forEach(m => renderMatch(m, container));
    updateModalOdds();

  } catch (err) {
    console.error("Fetch odds error:", err);
  } finally {
    clearTimeout(pollTimer);
    pollTimer = setTimeout(fetchOdds, REFRESH_INTERVAL);
  }
}

/* =====================
   RENDER MATCH
===================== */
function renderMatch(m, container) {
  const id = m.I;
  const teamA = m.O1E;
  const teamB = m.O2E;
  const oddsA = m.E?.[0]?.C || 1.0;
  const oddsB = m.E?.[1]?.C || 1.0;

  const nestedOdds = [];

  m.AE?.forEach(a =>
    a.ME?.forEach(k => {
      if (k.CE !== 1) return;

      const label =
        k.T === 9 ? `Total Over ${k.P}` :
        k.T === 10 ? `Total Under ${k.P}` :
        `Option ${k.T}`;

      nestedOdds.push({
        key: `${id}_${k.CE}_${k.T}`,
        label,
        odds: k.C
      });
    })
  );

  liveMatches[id] = { teamA, teamB, oddsA, oddsB, nestedOdds };

  const div = document.createElement("div");
  div.className = "match";

  div.innerHTML = `
    <a href="/bet/${id}" class="match-title">${teamA} vs ${teamB}</a>

    <div class="team">
      <span>${teamA}</span>
      <button class="btn" onclick="openModal('${id}','A','${teamA}',${oddsA})">${oddsA}</button>
    </div>

    <div class="team">
      <span>${teamB}</span>
      <button class="btn" onclick="openModal('${id}','B','${teamB}',${oddsB})">${oddsB}</button>
    </div>

    ${
      nestedOdds.length
        ? `<div class="teamm">
            ${nestedOdds.map(o =>
              `<button class="btnn"
                onclick="openModal('${id}','X','${o.key}',${o.odds})">
                ${o.label} - <span class="oddd">${o.odds}</span>
              </button>`
            ).join("")}
          </div>`
        : ""
    }
  `;

  container.appendChild(div);
}

/* =====================
   MODAL
===================== */
function openModal(matchId, team, name, odds) {
  selectedBet = { matchId, team, name, odds };
  const match = liveMatches[matchId];

  document.getElementById("matchTitle").innerText =
    `${match.teamA} vs ${match.teamB}`;
  document.getElementById("teamName").innerText = name;
  document.getElementById("teamOdds").innerText = odds;
  document.getElementById("betModal").style.display = "flex";
}

function closeModal() {
  document.getElementById("betModal").style.display = "none";
  selectedBet = null;
  document.getElementById("betAmount").value = 500;
}

/* =====================
   LIVE ODDS UPDATE
===================== */
function updateModalOdds() {
  if (!selectedBet) return;

  const match = liveMatches[selectedBet.matchId];
  if (!match) return;

  let newOdds = selectedBet.odds;

  if (selectedBet.team === "A") newOdds = match.oddsA;
  else if (selectedBet.team === "B") newOdds = match.oddsB;
  else {
    const opt = match.nestedOdds.find(o => o.key === selectedBet.name);
    if (opt) newOdds = opt.odds;
  }

  const el = document.getElementById("teamOdds");
  if (parseFloat(el.innerText) !== newOdds) {
    el.innerText = newOdds;
    selectedBet.odds = newOdds;
    el.classList.add("blink");
    setTimeout(() => el.classList.remove("blink"), 800);
  }
}

/* =====================
   PLACE BET
===================== */
async function placeBet() {
  if (!selectedBet) return;

  const amount = Number(document.getElementById("betAmount").value);
  if (!amount || amount <= 0) {
    return showToast("Enter valid amount", "error");
  }

  try {
    const res = await fetch("/bet", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        matchId: selectedBet.matchId,
        option: selectedBet.team,
        amount,
        odds: selectedBet.odds
      })
    });

    const data = await res.json();
    if (!data.success) throw new Error(data.message);

    showToast(`âœ… Bet placed @ ${data.data.odds}`, "success");
    closeModal();

  } catch (err) {
    console.error(err);
    showToast("Bet failed", "error");
  }
}

/* =====================
   INIT
===================== */
fetchOdds();
</script>

<%- include('footer') %>