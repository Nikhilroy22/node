<%- include('header') %>

<div class="match-wrapper">
  <div id="matchscore">Loading ...</div>
</div>

<input type="hidden" id="hiddenId" value="<%= matchid %>" />

<!-- Tabs -->
<div class="tabs" id="betoddstabs"></div>
<div class="tabdata" id="tabdata"></div>

<style>
.flash {
  animation: flashScore 1.5s ease;
}
@keyframes flashScore {
  0% { background: yellow; transform: scale(1.15); }
  100% { background: transparent; transform: scale(1); }
}

.odds-flash {
  animation: oddsFlash 1s ease;
}
@keyframes oddsFlash {
  0% { background: #ffeb3b; color: red; transform: scale(1.1); }
  100% { background: transparent; color: inherit; transform: scale(1); }
}
</style>

<script>
const hiddenInput = document.getElementById("hiddenId");

let prevS1 = 0, prevS2 = 0, prevPoints1 = 0, prevPoints2 = 0;
let fst = true;
let prevOdds = {};

async function viewodds() {
    const matchscore = document.getElementById("matchscore");
    const res = await fetch(`/resview/${hiddenInput.value}`);
    const data = await res.json();

    const PS = data?.Value?.SC?.PS || [];
    const FS = data?.Value?.SC?.FS || {};
    const lastSet = PS.length > 0 ? PS[PS.length - 1].Value : { S1: 0, S2: 0, NF: "-" };

    if (fst) {
        prevS1 = FS.S1 ?? 0;
        prevS2 = FS.S2 ?? 0;
        prevPoints1 = data?.Value?.SC.SS?.S1 ?? lastSet.S1 ?? 0;
        prevPoints2 = data?.Value?.SC?.SS?.S2 ?? lastSet.S2 ?? 0;
        fst = false;
    }

    matchscore.innerHTML = "";
    matchscore.className = "matchscore";

    /* Header */
    const matchheader = document.createElement("div");
    matchheader.className = "match-header";
    matchheader.innerHTML = `
        <span class="title">${data?.Value?.SN === "Badminton" ? "üè∏" : data?.Value?.SN === "Tennis" ? "üéæ" : data?.Value?.SN === "Football" ? "‚öΩÔ∏è" : data?.Value?.SN === "Cricket" ? "üèè" : ""} ${data?.Value?.L || ""}</span>
        <span class="status live">LIVE</span>`;
    matchscore.appendChild(matchheader);

    /* Teams */
    const teams = document.createElement("div");
    teams.className = "teams";
    teams.innerHTML = `
        <div class="team">
            <span class="name">${data?.Value?.O1 || "-"}</span>
            <span class="serve ${data?.Value?.SC.P == "1" ? "" : "off"}">üéæ</span>
            <span class="score" id="score1">${FS.S1 ?? 0}</span>
            <span class="points" id="points1">${data?.Value?.SC.SS?.S1 ?? lastSet.S1 ?? 0}</span>
        </div>

        <div class="vs">VS</div>

        <div class="team">
            <span class="name">${data?.Value?.O2 || "-"}</span>
            <span class="serve ${data?.Value?.SC.P == "2" ? "" : "off"}">üéæ</span>
            <span class="score" id="score2">${FS.S2 ?? 0}</span>
            <span class="points" id="points2">${data?.Value?.SC?.SS?.S2 ?? lastSet.S2 ?? 0}</span>
        </div>`;
    matchscore.appendChild(teams);

    /* FLASH */
    const score1El = document.getElementById("score1");
    const score2El = document.getElementById("score2");
    const points1El = document.getElementById("points1");
    const points2El = document.getElementById("points2");

    function flash(el) {
        el.classList.add("flash");
        setTimeout(() => el.classList.remove("flash"), 1200);
    }

    if ((FS.S1 ?? 0) !== prevS1) flash(score1El);
    if ((FS.S2 ?? 0) !== prevS2) flash(score2El);
    if ((data?.Value?.SC.SS?.S1 ?? lastSet.S1 ?? 0) !== prevPoints1) flash(points1El);
    if ((data?.Value?.SC?.SS?.S2 ?? lastSet.S2 ?? 0) !== prevPoints2) flash(points2El);

    prevS1 = FS.S1 ?? 0;
    prevS2 = FS.S2 ?? 0;
    prevPoints1 = data?.Value?.SC.SS?.S1 ?? lastSet.S1 ?? 0;
    prevPoints2 = data?.Value?.SC?.SS?.S2 ?? lastSet.S2 ?? 0;

    /* Set Table */
    const ttst = document.createElement("div");
    ttst.className = "newset";
    PS.forEach(s => {
        ttst.innerHTML += `
            <div class="set-box">
                <span class="set-name">${s?.Value?.NF || "-"}</span>
                <span class="set-score">${s?.Value?.S1 ?? 0} : ${s?.Value?.S2 ?? 0}</span>
            </div>`;
    });
    matchscore.appendChild(ttst);

    /* ===== ODDS SECTION ===== */
    const tabBox = document.getElementById("tabdata");
    const activeTabText = document.querySelector(".tab.active")?.innerText;
    const GE = data?.Value?.GE || [];

    function renderOdds(targetGS = null) {
        if (GE.length === 0) return "<p>No odds available</p>";
        let html = `<div class="odds-wrapper">`;

        GE.forEach(group => {
            if (targetGS && group.GS !== targetGS) return;
            html += `<div class="market-group">
                        <div class="market-title">Market G: ${group.G}, GS: ${group.GS}</div>`;
            group.E.forEach((row, rIndex) => {
                html += `<div class="odd-row">`;
                row.forEach((o, cIndex) => {
                    const key = `${group.G}_${group.GS}_${rIndex}_${cIndex}`;
                    const changed = prevOdds[key] !== undefined && prevOdds[key] !== o.C;
                    prevOdds[key] = o.C;

                    html += `
                        <div class="odd-box ${changed ? "odds-flash" : ""}">
                            <span class="odd-name">${o.P !== undefined ? o.P : ''}</span>
                            <button class="odd-btn">${o.C}</button>
                        </div>`;
                });
                html += `</div>`;
            });
            html += `</div>`;
        });

        html += `</div>`;
        return html;
    }

    if (activeTabText === "Regular time") tabBox.innerHTML = renderOdds();
    else if (activeTabText === "1st set") tabBox.innerHTML = renderOdds(1);
    else if (activeTabText === "2st set") tabBox.innerHTML = renderOdds(2);

    setTimeout(viewodds, 5000);
}

/* Tabs */
const tabData = [
 { id: "home", name: "Regular time", content: '' },
 { id: "1st", name: "1st set", content: '' },
 { id: "2set", name: "2st set", content: '' },
];

const tabsContainer = document.getElementById('betoddstabs');
const app = document.getElementById('tabdata');

tabData.forEach((tab, index) => {
    const tabDiv = document.createElement('div');
    tabDiv.classList.add('tab');
    tabDiv.textContent = tab.name;
    tabDiv.addEventListener('click', () => changeTab(tab.id));
    tabsContainer.appendChild(tabDiv);
});

function changeTab(tabId) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    const activeTab = tabData.find(t => t.id === tabId) || tabData[0];
    const index = tabData.indexOf(activeTab);
    document.querySelectorAll('.tab')[index].classList.add('active');
    app.innerHTML = activeTab.content;
    viewodds(); // refresh odds for selected tab
}

changeTab("home"); // default
viewodds();        // initial call
</script>

<%- include('footer') %>