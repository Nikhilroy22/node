jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git cmake clang make ninja-build wget unzip curl pkg-config

      - name: Download Android NDK
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
          unzip android-ndk-r25b-linux.zip -d $HOME/Android

      - name: Setup Android NDK environment
        run: |
          echo "ANDROID_NDK_ROOT=$HOME/Android/android-ndk-r25b" >> $GITHUB_ENV
          echo "$HOME/Android/android-ndk-r25b/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      - name: Clone Node.js
        run: |
          git clone --branch v20.0.0 https://github.com/nodejs/node.git

      - name: Apply Android patches
        run: |
          cd node
          git apply ../android-patches/trap-handler.h.patch || echo "No patch found"

      - name: Build Node.js for ARM32 Android
        run: |
          cd node
          export ANDROID_NDK_ROOT=$HOME/Android/android-ndk-r25b
          export PATH=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          ./configure --cross-compiling --dest-cpu=arm --dest-os=android
          make -j$(nproc)